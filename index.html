<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa AR - Debug Version</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .step {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .step.active {
            border-color: #007bff;
            background: #f0f8ff;
        }
        
        .step.success {
            border-color: #28a745;
            background: #f0fff0;
        }
        
        .step.error {
            border-color: #dc3545;
            background: #fff0f0;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .button.success {
            background: #28a745;
        }
        
        .button.error {
            background: #dc3545;
        }
        
        #videoContainer {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîç Santa AR - Debug Mode</h2>
        <p>Let's test each step to find the issue!</p>
        
        <!-- Step 1: HTTPS Check -->
        <div class="step" id="step1">
            <h4>Step 1: HTTPS Check</h4>
            <p id="httpsStatus">Checking...</p>
        </div>
        
        <!-- Step 2: Browser Check -->
        <div class="step" id="step2">
            <h4>Step 2: Browser Compatibility</h4>
            <p id="browserStatus">Checking...</p>
        </div>
        
        <!-- Step 3: Camera Permissions -->
        <div class="step" id="step3">
            <h4>Step 3: Camera Permission Test</h4>
            <button class="button" id="cameraButton" onclick="testCamera()">
                üì∑ Test Camera Access
            </button>
            <div id="videoContainer">
                <video id="video" autoplay playsinline></video>
            </div>
            <p id="cameraStatus">Click button to test</p>
        </div>
        
        <!-- Step 4: WebAR Libraries -->
        <div class="step" id="step4">
            <h4>Step 4: WebAR Library Test</h4>
            <button class="button" id="arButton" onclick="testAR()" disabled>
                üéÖ Test AR (after camera works)
            </button>
            <p id="arStatus">Complete camera test first</p>
        </div>
        
        <div class="info">
            <strong>üì± Device Info:</strong><br>
            <span id="deviceInfo">Loading...</span>
        </div>
        
        <div class="info" id="debugLog" style="display: none;">
            <strong>üîç Debug Log:</strong><br>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let debugLog = [];
        let stream = null;
        
        function log(message) {
            console.log(message);
            debugLog.push(new Date().toLocaleTimeString() + ": " + message);
            document.getElementById('logContent').innerHTML = debugLog.join('<br>');
            document.getElementById('debugLog').style.display = 'block';
        }
        
        function updateStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            
            const statusElement = document.getElementById(stepId.replace('step', '') + 'Status') || 
                                 step.querySelector('p');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        // Step 1: Check HTTPS
        function checkHTTPS() {
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost';
            
            if (isHTTPS || isLocalhost) {
                updateStep('step1', 'success', '‚úÖ HTTPS detected - camera access possible');
                log('HTTPS check passed');
                return true;
            } else {
                updateStep('step1', 'error', '‚ùå HTTPS required for camera access');
                log('HTTPS check failed - using ' + location.protocol);
                return false;
            }
        }
        
        // Step 2: Check Browser
        function checkBrowser() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent);
            
            let browserStatus = '';
            let isGoodBrowser = false;
            
            if (isIOS) {
                if (isSafari) {
                    browserStatus = '‚úÖ iOS Safari - Perfect for WebAR';
                    isGoodBrowser = true;
                } else {
                    browserStatus = '‚ö†Ô∏è iOS detected but not Safari. Try Safari instead.';
                }
            } else if (isAndroid) {
                if (isChrome) {
                    browserStatus = '‚úÖ Android Chrome - Perfect for WebAR';
                    isGoodBrowser = true;
                } else {
                    browserStatus = '‚ö†Ô∏è Android detected but not Chrome. Try Chrome instead.';
                }
            } else {
                browserStatus = '‚ö†Ô∏è Desktop browser detected. Use mobile device for AR.';
            }
            
            updateStep('step2', isGoodBrowser ? 'success' : 'error', browserStatus);
            log('Browser check: ' + browserStatus);
            return isGoodBrowser;
        }
        
        // Step 3: Test Camera
        async function testCamera() {
            const button = document.getElementById('cameraButton');
            const video = document.getElementById('video');
            const container = document.getElementById('videoContainer');
            
            button.disabled = true;
            button.textContent = 'üì∑ Testing Camera...';
            updateStep('step3', 'active', 'Requesting camera access...');
            log('Starting camera test');
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = function() {
                    container.style.display = 'block';
                    updateStep('step3', 'success', '‚úÖ Camera working! You should see video above.');
                    button.textContent = 'üõë Stop Camera';
                    button.onclick = stopCamera;
                    button.disabled = false;
                    button.className = 'button success';
                    
                    // Enable AR test
                    document.getElementById('arButton').disabled = false;
                    updateStep('step4', 'active', 'Ready to test AR!');
                    
                    log('Camera started successfully');
                };
                
            } catch (error) {
                let errorMsg = '‚ùå Camera failed: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'Permission denied. Check browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'No camera found.';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg += 'Camera not supported in this browser.';
                } else {
                    errorMsg += error.message;
                }
                
                updateStep('step3', 'error', errorMsg);
                button.textContent = 'üì∑ Try Again';
                button.disabled = false;
                button.className = 'button error';
                
                log('Camera error: ' + error.name + ' - ' + error.message);
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('cameraButton').textContent = 'üì∑ Test Camera Access';
            document.getElementById('cameraButton').onclick = testCamera;
            document.getElementById('cameraButton').className = 'button';
            updateStep('step3', '', 'Click button to test camera');
            log('Camera stopped');
        }
        
        function testAR() {
            updateStep('step4', 'active', 'Loading AR libraries...');
            log('Testing AR libraries');
            
            // Test if A-Frame and AR.js are available
            setTimeout(() => {
                if (typeof AFRAME !== 'undefined') {
                    updateStep('step4', 'success', '‚úÖ AR libraries loaded! Your setup is ready.');
                    log('AR libraries test passed');
                    
                    // Show link to full AR experience
                    const step4 = document.getElementById('step4');
                    step4.innerHTML += `
                        <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
                            <h4>üéâ Ready for Full AR!</h4>
                            <p>Your setup works! Go back to your main Santa AR page and try again.</p>
                            <p><strong>Tip:</strong> Make sure to print or display the demo sign on another screen.</p>
                        </div>
                    `;
                } else {
                    updateStep('step4', 'error', '‚ùå AR libraries failed to load');
                    log('AR libraries test failed');
                }
            }, 2000);
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            // Device info
            document.getElementById('deviceInfo').textContent = navigator.userAgent.substring(0, 100) + '...';
            
            // Run checks
            checkHTTPS();
            checkBrowser();
            
            log('Debug page loaded');
        });
    </script>
</body>
</html>
